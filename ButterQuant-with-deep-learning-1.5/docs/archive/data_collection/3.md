#!/bin/bash

# 快速启动脚本 - 每日股票扫描系统
# 用途: 一键安装和启动扫描系统

set -e  # 遇到错误立即退出

echo "========================================="
echo "  Daily Stock Scanner - Quick Start"
echo "========================================="
echo ""

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 检查Python版本
check_python() {
    echo "Checking Python version..."
    if ! command -v python3 &> /dev/null; then
        echo -e "${RED}Error: Python 3 is not installed${NC}"
        exit 1
    fi
    
    PYTHON_VERSION=$(python3 --version | cut -d' ' -f2 | cut -d'.' -f1,2)
    echo -e "${GREEN}✓ Found Python $PYTHON_VERSION${NC}"
}

# 安装依赖
install_dependencies() {
    echo ""
    echo "Installing dependencies..."
    
    if [ ! -f "requirements.txt" ]; then
        echo "Creating requirements.txt..."
        cat > requirements.txt << EOF
yfinance>=0.2.36
apscheduler>=3.10.4
pytz>=2023.3
pandas>=2.0.0
requests>=2.31.0
pyyaml>=6.0
flask>=2.3.0
EOF
    fi
    
    pip3 install -q -r requirements.txt
    echo -e "${GREEN}✓ Dependencies installed${NC}"
}

# 创建目录结构
create_directories() {
    echo ""
    echo "Creating directory structure..."
    
    mkdir -p backend/scheduler
    mkdir -p backend/data
    mkdir -p backend/utils
    
    # 创建__init__.py文件
    touch backend/__init__.py
    touch backend/scheduler/__init__.py
    touch backend/utils/__init__.py
    
    echo -e "${GREEN}✓ Directories created${NC}"
}

# 初始化股票列表
init_ticker_lists() {
    echo ""
    echo "Initializing ticker lists..."
    
    if [ ! -f "backend/data/nas100.md" ] || [ ! -f "backend/data/sp500.md" ]; then
        echo "Fetching ticker lists from online sources..."
        python3 backend/utils/ticker_utils.py --update
        echo -e "${GREEN}✓ Ticker lists downloaded${NC}"
    else
        echo -e "${YELLOW}Ticker lists already exist, skipping...${NC}"
    fi
}

# 运行测试
run_test() {
    echo ""
    echo "Running test scan (first 5 stocks)..."
    
    # 创建测试脚本
    cat > test_scan.py << 'EOF'
from backend.scheduler.daily_scanner import DailyScanner

scanner = DailyScanner()
tickers = scanner.load_tickers()[:5]  # 只扫描前5个
print(f"Testing with {len(tickers)} stocks: {tickers}")

results = []
for ticker in tickers:
    result = scanner.analyze_ticker(ticker)
    if result:
        results.append(result)
        print(f"✓ {ticker}: Score = {result['score']:.4f}")

print(f"\nTest completed: {len(results)}/{len(tickers)} successful")
EOF
    
    python3 test_scan.py
    rm test_scan.py
    
    echo -e "${GREEN}✓ Test completed${NC}"
}

# 选择运行模式
choose_mode() {
    echo ""
    echo "========================================="
    echo "Choose running mode:"
    echo "========================================="
    echo "1) Run scan immediately (one-time)"
    echo "2) Start scheduler (daily at 18:00 JST)"
    echo "3) Install as systemd service"
    echo "4) Exit"
    echo ""
    read -p "Enter your choice [1-4]: " choice
    
    case $choice in
        1)
            echo ""
            echo "Starting immediate scan..."
            python3 backend/scheduler/daily_scanner.py
            ;;
        2)
            echo ""
            echo "Starting scheduler..."
            echo "Press Ctrl+C to stop"
            python3 backend/scheduler/scheduler_manager.py
            ;;
        3)
            install_systemd_service
            ;;
        4)
            echo "Goodbye!"
            exit 0
            ;;
        *)
            echo -e "${RED}Invalid choice${NC}"
            choose_mode
            ;;
    esac
}

# 安装systemd服务
install_systemd_service() {
    echo ""
    echo "Installing systemd service..."
    
    CURRENT_DIR=$(pwd)
    CURRENT_USER=$(whoami)
    
    # 创建服务文件
    sudo tee /etc/systemd/system/stock-scanner.service > /dev/null << EOF
[Unit]
Description=Daily Stock Scanner Service
After=network.target

[Service]
Type=simple
User=$CURRENT_USER
WorkingDirectory=$CURRENT_DIR
Environment="PATH=/usr/bin:/usr/local/bin"
ExecStart=$(which python3) $CURRENT_DIR/backend/scheduler/scheduler_manager.py
Restart=on-failure
RestartSec=10
StandardOutput=append:$CURRENT_DIR/backend/data/service_output.log
StandardError=append:$CURRENT_DIR/backend/data/service_error.log

[Install]
WantedBy=multi-user.target
EOF
    
    # 重新加载并启动服务
    sudo systemctl daemon-reload
    sudo systemctl enable stock-scanner
    sudo systemctl start stock-scanner
    
    echo -e "${GREEN}✓ Service installed and started${NC}"
    echo ""
    echo "Useful commands:"
    echo "  sudo systemctl status stock-scanner    # Check status"
    echo "  sudo systemctl stop stock-scanner      # Stop service"
    echo "  sudo systemctl restart stock-scanner   # Restart service"
    echo "  sudo journalctl -u stock-scanner -f    # View logs"
}

# 主流程
main() {
    check_python
    install_dependencies
    create_directories
    init_ticker_lists
    
    echo ""
    echo -e "${GREEN}Setup completed successfully!${NC}"
    
    read -p "Do you want to run a quick test? (y/n): " run_test_choice
    if [ "$run_test_choice" = "y" ] || [ "$run_test_choice" = "Y" ]; then
        run_test
    fi
    
    choose_mode
}

# 执行主流程
main