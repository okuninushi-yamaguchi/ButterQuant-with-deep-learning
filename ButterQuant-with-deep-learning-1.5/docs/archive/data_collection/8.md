"""
定时任务管理器
每天东京时间18:00启动扫描任务
"""

from apscheduler.schedulers.blocking import BlockingScheduler
from apscheduler.triggers.cron import CronTrigger
from datetime import datetime
import pytz
import logging
from pathlib import Path

from backend.scheduler.daily_scanner import DailyScanner


class SchedulerManager:
    """定时任务管理器"""
    
    def __init__(self):
        self.scheduler = BlockingScheduler(
            timezone=pytz.timezone('Asia/Tokyo')
        )
        self.scanner = DailyScanner()
        self._setup_logging()
    
    def _setup_logging(self):
        """配置日志"""
        log_file = Path("backend/data/scheduler.log")
        log_file.parent.mkdir(parents=True, exist_ok=True)
        
        logging.basicConfig(
            level=logging.INFO,
            format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
            handlers=[
                logging.FileHandler(log_file),
                logging.StreamHandler()
            ]
        )
        self.logger = logging.getLogger(__name__)
    
    def daily_scan_job(self):
        """每日扫描任务"""
        try:
            tokyo_tz = pytz.timezone('Asia/Tokyo')
            current_time = datetime.now(tokyo_tz)
            
            self.logger.info("=" * 60)
            self.logger.info(f"Daily scan job triggered at {current_time.strftime('%Y-%m-%d %H:%M:%S %Z')}")
            self.logger.info("=" * 60)
            
            # 执行扫描
            self.scanner.scan_all()
            
            self.logger.info("Daily scan job completed successfully")
            
        except Exception as e:
            self.logger.error(f"Daily scan job failed: {str(e)}", exc_info=True)
    
    def start(self):
        """启动定时任务"""
        # 每天东京时间18:00执行
        self.scheduler.add_job(
            self.daily_scan_job,
            trigger=CronTrigger(
                hour=18,
                minute=0,
                timezone=pytz.timezone('Asia/Tokyo')
            ),
            id='daily_scan',
            name='Daily Market Scan',
            replace_existing=True
        )
        
        tokyo_tz = pytz.timezone('Asia/Tokyo')
        current_time = datetime.now(tokyo_tz)
        
        self.logger.info("Scheduler started")
        self.logger.info(f"Current time (Tokyo): {current_time.strftime('%Y-%m-%d %H:%M:%S %Z')}")
        self.logger.info("Next scan scheduled at: 18:00 JST daily")
        self.logger.info("Press Ctrl+C to exit")
        
        # 显示所有已注册的任务
        jobs = self.scheduler.get_jobs()
        for job in jobs:
            self.logger.info(f"Job: {job.name}, Next run: {job.next_run_time}")
        
        try:
            self.scheduler.start()
        except (KeyboardInterrupt, SystemExit):
            self.logger.info("Scheduler stopped by user")
            self.scheduler.shutdown()


# 命令行运行
if __name__ == "__main__":
    import sys
    
    if len(sys.argv) > 1 and sys.argv[1] == '--now':
        # 立即运行一次（用于测试）
        print("Running scan immediately (test mode)...")
        scanner = DailyScanner()
        scanner.scan_all()
    else:
        # 启动定时任务
        manager = SchedulerManager()
        manager.start()