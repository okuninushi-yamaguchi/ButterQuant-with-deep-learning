# æ¯æ—¥è‚¡ç¥¨æ‰«æç³»ç»Ÿ - éƒ¨ç½²å’Œä½¿ç”¨æŒ‡å—

## ğŸ“‹ ç›®å½•
1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [ç¯å¢ƒå‡†å¤‡](#ç¯å¢ƒå‡†å¤‡)
3. [å®‰è£…æ­¥éª¤](#å®‰è£…æ­¥éª¤)
4. [ä½¿ç”¨æ–¹æ³•](#ä½¿ç”¨æ–¹æ³•)
5. [ç›‘æ§å’Œç»´æŠ¤](#ç›‘æ§å’Œç»´æŠ¤)
6. [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

---

## ç³»ç»Ÿæ¦‚è¿°

### åŠŸèƒ½
- æ¯å¤©ä¸œäº¬æ—¶é—´18:00è‡ªåŠ¨æ‰«æNasdaq 100å’ŒS&P 500è‚¡ç¥¨
- ä½¿ç”¨yfinanceè·å–å¸‚åœºæ•°æ®ï¼Œæ¯15ç§’ä¸€æ¬¡è¯·æ±‚
- è®¡ç®—æ¯ä¸ªè‚¡ç¥¨çš„ç­–ç•¥å¾—åˆ†å¹¶æ’å
- æ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼Œæ‰«æè¿›åº¦å®æ—¶ä¿å­˜
- é¢„è®¡1å°æ—¶å®Œæˆå…¨éƒ¨æ‰«æ

### ä¼˜åŠ¿
- **é¿å¼€é«˜å³°æœŸ**: åœ¨ç¾è‚¡ç›˜åã€äºšæ´²äº¤æ˜“æ—¶æ®µè¿è¡Œ
- **æ•°æ®æ–°é²œ**: æ¯å¤©19:00åå³å¯è®¿é—®å½“æ—¥æ’å
- **ç¨³å®šå¯é **: é€è¡Œä¿å­˜è¿›åº¦ï¼Œæ”¯æŒä¸­æ–­æ¢å¤
- **å»é‡ä¼˜åŒ–**: è‡ªåŠ¨å¤„ç†é‡å¤è‚¡ç¥¨

---

## ç¯å¢ƒå‡†å¤‡

### ç³»ç»Ÿè¦æ±‚
- Python 3.8+
- Linux/MacOS/Windows Server
- è‡³å°‘2GB RAM
- ç¨³å®šçš„ç½‘ç»œè¿æ¥

### ä¾èµ–åŒ…
```bash
pip install -r requirements.txt
```

**requirements.txt:**
```
yfinance>=0.2.36
apscheduler>=3.10.4
pytz>=2023.3
pandas>=2.0.0
requests>=2.31.0
pyyaml>=6.0
```

---

## å®‰è£…æ­¥éª¤

### 1. å…‹éš†é¡¹ç›®
```bash
cd your-project-directory
```

### 2. åˆ›å»ºç›®å½•ç»“æ„
```bash
mkdir -p backend/scheduler
mkdir -p backend/data
mkdir -p backend/utils
```

### 3. æ”¾ç½®æ–‡ä»¶
å°†ä»¥ä¸‹æ–‡ä»¶æ”¾åˆ°å¯¹åº”ä½ç½®ï¼š
```
backend/
â”œâ”€â”€ scheduler/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ daily_scanner.py
â”‚   â”œâ”€â”€ scheduler_manager.py
â”‚   â””â”€â”€ config.yaml
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ nas100.md
â”‚   â””â”€â”€ sp500.md
â””â”€â”€ utils/
    â””â”€â”€ ticker_utils.py
```

### 4. åˆå§‹åŒ–è‚¡ç¥¨åˆ—è¡¨

**é€‰é¡¹A: æ‰‹åŠ¨åˆ›å»º**
```bash
# åœ¨nas100.mdå’Œsp500.mdä¸­æ¯è¡Œå†™ä¸€ä¸ªè‚¡ç¥¨ä»£ç 
# ç¤ºä¾‹:
echo "AAPL
MSFT
GOOGL" > backend/data/nas100.md
```

**é€‰é¡¹B: è‡ªåŠ¨è·å–ï¼ˆæ¨èï¼‰**
```bash
python backend/utils/ticker_utils.py --update
```

### 5. éªŒè¯å®‰è£…
```bash
# æµ‹è¯•æ‰«æå™¨
python backend/scheduler/daily_scanner.py --help

# æµ‹è¯•ç«‹å³è¿è¡Œï¼ˆæ‰«æå°‘é‡è‚¡ç¥¨ï¼‰
python backend/scheduler/scheduler_manager.py --now
```

---

## ä½¿ç”¨æ–¹æ³•

### æ–¹å¼1: å‘½ä»¤è¡Œè¿è¡Œï¼ˆæ¨èç”¨äºå¼€å‘/æµ‹è¯•ï¼‰

#### ç«‹å³æ‰§è¡Œä¸€æ¬¡æ‰«æ
```bash
cd backend/scheduler
python daily_scanner.py
```

#### é‡ç½®è¿›åº¦å¹¶é‡æ–°æ‰«æ
```bash
python daily_scanner.py --reset
python daily_scanner.py
```

#### å¯åŠ¨å®šæ—¶ä»»åŠ¡
```bash
python scheduler_manager.py
```

#### ç«‹å³è¿è¡Œä¸€æ¬¡ï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰
```bash
python scheduler_manager.py --now
```

---

### æ–¹å¼2: systemdæœåŠ¡ï¼ˆæ¨èç”¨äºç”Ÿäº§ç¯å¢ƒï¼‰

#### åˆ›å»ºæœåŠ¡æ–‡ä»¶
```bash
sudo nano /etc/systemd/system/stock-scanner.service
```

**stock-scanner.service:**
```ini
[Unit]
Description=Daily Stock Scanner Service
After=network.target

[Service]
Type=simple
User=your-username
WorkingDirectory=/path/to/your/project
Environment="PATH=/usr/bin:/usr/local/bin"
ExecStart=/usr/bin/python3 /path/to/backend/scheduler/scheduler_manager.py
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
```

#### å¯åŠ¨æœåŠ¡
```bash
# é‡æ–°åŠ è½½é…ç½®
sudo systemctl daemon-reload

# å¯åŠ¨æœåŠ¡
sudo systemctl start stock-scanner

# è®¾ç½®å¼€æœºè‡ªå¯
sudo systemctl enable stock-scanner

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status stock-scanner

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u stock-scanner -f
```

---

### æ–¹å¼3: Dockerå®¹å™¨ï¼ˆå¯é€‰ï¼‰

#### Dockerfile
```dockerfile
FROM python:3.10-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY backend/ backend/

ENV TZ=Asia/Tokyo
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

CMD ["python", "backend/scheduler/scheduler_manager.py"]
```

#### æ„å»ºå’Œè¿è¡Œ
```bash
# æ„å»ºé•œåƒ
docker build -t stock-scanner .

# è¿è¡Œå®¹å™¨
docker run -d \
  --name stock-scanner \
  -v $(pwd)/backend/data:/app/backend/data \
  --restart unless-stopped \
  stock-scanner

# æŸ¥çœ‹æ—¥å¿—
docker logs -f stock-scanner
```

---

## ç›‘æ§å’Œç»´æŠ¤

### 1. æ£€æŸ¥æ‰«æçŠ¶æ€

#### æŸ¥çœ‹è¿›åº¦æ–‡ä»¶
```bash
tail -f backend/data/scan_progress.txt
```

ç¤ºä¾‹è¾“å‡º:
```
2025-01-07 18:00:15|AAPL|SUCCESS|0.8523
2025-01-07 18:00:30|MSFT|SUCCESS|0.7891
2025-01-07 18:00:45|GOOGL|NO_DATA|N/A
```

#### æŸ¥çœ‹æ—¥å¿—
```bash
tail -f backend/data/scan_log.txt
```

#### æŸ¥çœ‹ç»“æœ
```bash
cat backend/data/rankings_combined.json | head -20
```

### 2. ç›‘æ§è„šæœ¬

åˆ›å»º `monitor.sh`:
```bash
#!/bin/bash

echo "=== Stock Scanner Status ==="
echo ""

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
echo "Service Status:"
systemctl is-active stock-scanner

# æ£€æŸ¥æœ€åæ‰«ææ—¶é—´
if [ -f backend/data/rankings_combined.json ]; then
    echo ""
    echo "Last Scan:"
    cat backend/data/rankings_combined.json | grep "last_updated"
fi

# æ£€æŸ¥ä»Šå¤©çš„è¿›åº¦
echo ""
echo "Today's Progress:"
TODAY=$(date +%Y-%m-%d)
grep "$TODAY" backend/data/scan_progress.txt | tail -5

# æ£€æŸ¥ç£ç›˜ç©ºé—´
echo ""
echo "Disk Usage:"
du -sh backend/data/

echo ""
echo "=== End of Report ==="
```

ä½¿ç”¨:
```bash
chmod +x monitor.sh
./monitor.sh
```

### 3. è®¾ç½®å‘Šè­¦

åˆ›å»º `alert.sh` (é€šè¿‡é‚®ä»¶æˆ–Webhookå‘é€å‘Šè­¦):
```bash
#!/bin/bash

# æ£€æŸ¥æœ€åæ›´æ–°æ—¶é—´
LAST_UPDATE=$(cat backend/data/rankings_combined.json | grep "last_updated" | cut -d'"' -f4)
LAST_TIMESTAMP=$(date -d "$LAST_UPDATE" +%s)
NOW_TIMESTAMP=$(date +%s)
HOURS_AGO=$(( ($NOW_TIMESTAMP - $LAST_TIMESTAMP) / 3600 ))

if [ $HOURS_AGO -gt 25 ]; then
    echo "Alert: Data is $HOURS_AGO hours old!"
    # å‘é€é‚®ä»¶æˆ–Webhooké€šçŸ¥
    # curl -X POST your-webhook-url -d "Data outdated!"
fi
```

æ·»åŠ åˆ°crontab (æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡):
```bash
crontab -e
# æ·»åŠ :
0 * * * * /path/to/alert.sh
```

---

## åç«¯APIé›†æˆ

### ä¿®æ”¹ Flask API

**backend/app.py:**
```python
from flask import Flask, jsonify
import json
from pathlib import Path

app = Flask(__name__)

@app.route('/api/rankings', methods=['GET'])
def get_rankings():
    """è¿”å›æ‰€æœ‰æ’å"""
    try:
        with open('backend/data/rankings_combined.json', 'r') as f:
            data = json.load(f)
        return jsonify(data)
    except FileNotFoundError:
        return jsonify({'error': 'Rankings not available yet'}), 404

@app.route('/api/rankings/top20', methods=['GET'])
def get_top20():
    """è¿”å›å‰20åï¼ˆå¿«é€Ÿå“åº”ï¼‰"""
    try:
        with open('backend/data/rankings_top20.json', 'r') as f:
            data = json.load(f)
        return jsonify(data)
    except FileNotFoundError:
        return jsonify({'error': 'Rankings not available yet'}), 404

@app.route('/api/rankings/status', methods=['GET'])
def get_scan_status():
    """è¿”å›æ‰«æçŠ¶æ€"""
    progress_file = Path('backend/data/scan_progress.txt')
    
    if not progress_file.exists():
        return jsonify({'status': 'no_data'})
    
    # ç»Ÿè®¡ä»Šå¤©çš„æ‰«æè¿›åº¦
    from datetime import datetime
    today = datetime.now().strftime('%Y-%m-%d')
    
    total = 0
    success = 0
    
    with open(progress_file, 'r') as f:
        for line in f:
            if today in line:
                total += 1
                if 'SUCCESS' in line:
                    success += 1
    
    return jsonify({
        'status': 'completed' if total > 500 else 'in_progress',
        'date': today,
        'progress': success,
        'total': total
    })

if __name__ == '__main__':
    app.run(debug=True, port=5000)
```

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜1: æ‰«ææœªå¯åŠ¨
**ç—‡çŠ¶**: åˆ°äº†18:00ä½†æ²¡æœ‰å¼€å§‹æ‰«æ

**è§£å†³**:
```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
systemctl status stock-scanner

# æ£€æŸ¥æ—¶åŒºè®¾ç½®
timedatectl

# æ‰‹åŠ¨è¿è¡Œæµ‹è¯•
python backend/scheduler/scheduler_manager.py --now
```

### é—®é¢˜2: æ‰«æé€Ÿåº¦æ…¢
**ç—‡çŠ¶**: è¶…è¿‡2å°æ—¶è¿˜æœªå®Œæˆ

**è§£å†³**:
1. æ£€æŸ¥ç½‘ç»œè¿æ¥
2. è°ƒæ•´ `request_interval` (å‡å°‘åˆ°10ç§’)
3. æ£€æŸ¥æ˜¯å¦æœ‰è‚¡ç¥¨å¡ä½:
```bash
tail -100 backend/data/scan_progress.txt | grep "ERROR"
```

### é—®é¢˜3: å†…å­˜ä¸è¶³
**ç—‡çŠ¶**: è¿›ç¨‹è¢«killed

**è§£å†³**:
1. å¢åŠ æœåŠ¡å™¨å†…å­˜
2. ä¿®æ”¹ `batch_checkpoint` ä¸ºæ›´å°çš„å€¼ (å¦‚5)
3. é™åˆ¶è¿›ç¨‹å†…å­˜:
```ini
# åœ¨systemdæœåŠ¡æ–‡ä»¶ä¸­æ·»åŠ 
[Service]
MemoryLimit=1G
```

### é—®é¢˜4: æ•°æ®ä¸å‡†ç¡®
**ç—‡çŠ¶**: æŸäº›è‚¡ç¥¨æ•°æ®å¼‚å¸¸

**è§£å†³**:
1. æ›´æ–°yfinance:
```bash
pip install --upgrade yfinance
```

2. æ£€æŸ¥ç‰¹å®šè‚¡ç¥¨:
```python
import yfinance as yf
stock = yf.Ticker("AAPL")
print(stock.info)
```

3. é‡æ–°æ‰«æ:
```bash
python daily_scanner.py --reset
python daily_scanner.py
```

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. ä½¿ç”¨æœ¬åœ°ç¼“å­˜
```python
# åœ¨daily_scanner.pyä¸­æ·»åŠ 
import functools
from datetime import datetime, timedelta

@functools.lru_cache(maxsize=1000)
def cached_yfinance_call(ticker, date):
    """ç¼“å­˜yfinanceè°ƒç”¨ï¼ˆå½“å¤©æœ‰æ•ˆï¼‰"""
    stock = yf.Ticker(ticker)
    return stock.info
```

### 2. å¹¶è¡Œå¤„ç†ï¼ˆå®éªŒæ€§ï¼‰
```python
# ä½¿ç”¨ProcessPoolExecutorä»£æ›¿ThreadPoolExecutor
from concurrent.futures import ProcessPoolExecutor

# æ³¨æ„: yfinanceåœ¨å¤šè¿›ç¨‹ç¯å¢ƒå¯èƒ½æœ‰é—®é¢˜
```

### 3. æ•°æ®åº“å­˜å‚¨ï¼ˆå¯é€‰ï¼‰
ä½¿ç”¨SQLiteæˆ–PostgreSQLå­˜å‚¨ç»“æœ:
```python
import sqlite3

def save_to_db(results):
    conn = sqlite3.connect('backend/data/rankings.db')
    cursor = conn.cursor()
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS rankings (
            date TEXT,
            ticker TEXT,
            score REAL,
            strategy TEXT,
            PRIMARY KEY (date, ticker)
        )
    ''')
    
    for r in results:
        cursor.execute('''
            INSERT OR REPLACE INTO rankings VALUES (?, ?, ?, ?)
        ''', (datetime.now().date(), r['ticker'], r['score'], r['strategy_type']))
    
    conn.commit()
    conn.close()
```

---

## æ€»ç»“

âœ… **ä¼˜åŠ¿**
- è‡ªåŠ¨åŒ–è¿è¡Œ,æ— éœ€äººå·¥å¹²é¢„
- ç¨³å®šå¯é ,æ”¯æŒæ–­ç‚¹ç»­ä¼ 
- æ•°æ®æ–°é²œ,æ¯å¤©æ›´æ–°
- æ˜“äºç›‘æ§å’Œç»´æŠ¤

âš ï¸ **æ³¨æ„äº‹é¡¹**
- ç¡®ä¿ç½‘ç»œç¨³å®š
- å®šæœŸæ£€æŸ¥æ—¥å¿—
- ç›‘æ§ç£ç›˜ç©ºé—´
- åŠæ—¶æ›´æ–°ä¾èµ–

ğŸ“ **æ”¯æŒ**
é‡åˆ°é—®é¢˜è¯·æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶:
- `backend/data/scan_log.txt`
- `backend/data/scheduler.log`