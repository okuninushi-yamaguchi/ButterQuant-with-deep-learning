# ğŸš€ æœºå™¨å­¦ä¹ äº¤æ˜“ç³»ç»Ÿå®æ–½è®¡åˆ’

## ğŸ¯ æ€»ä½“ç›®æ ‡

å»ºç«‹åŒè´¦æˆ·å¼ºåŒ–å­¦ä¹ ç³»ç»Ÿï¼š
- **è´¦æˆ· A (Baseline)**ï¼šä½¿ç”¨å›ºå®šæƒé‡ [35%, 30%, 20%, 15%]
- **è´¦æˆ· B (RL)**ï¼šä½¿ç”¨æœºå™¨å­¦ä¹ åŠ¨æ€è°ƒæ•´æƒé‡
- **å¯¹æ¯”å‘¨æœŸ**ï¼š3-6 ä¸ªæœˆ
- **æˆåŠŸæ ‡å‡†**ï¼šRL è´¦æˆ· Sharpe Ratio > Baseline + 0.2

---

## ğŸ“… å®æ–½æ—¶é—´çº¿

### **Week 1-2ï¼šç¯å¢ƒæ­å»º**

#### **ä»»åŠ¡ 1.1ï¼šå®‰è£…ç›ˆé€ TWS**
```bash
# 1. ä¸‹è½½ TWSï¼ˆTrader Workstationï¼‰
# https://www.interactivebrokers.com/en/trading/tws.php

# 2. å¼€è®¾ä¸¤ä¸ª Paper Trading è´¦æˆ·
# ç™»å½• IBKR Client Portal â†’ Paper Trading â†’ Create Account

# 3. é…ç½® API è®¾ç½®
# TWS â†’ Edit â†’ Global Configuration â†’ API â†’ Settings
# - Enable ActiveX and Socket Clients: âœ…
# - Socket Port: 7497 (Paper) / 7496 (Live)
# - Master API Client ID: 0
```

#### **ä»»åŠ¡ 1.2ï¼šå®‰è£… Python ä¾èµ–**
```bash
pip install ib_insync
pip install torch torchvision  # PyTorchï¼ˆä½ å·²æœ‰ï¼‰
pip install pandas numpy scipy
pip install psycopg2-binary  # PostgreSQLï¼ˆå¦‚æœé˜¶æ®µ2å·²å‡çº§ï¼‰
```

#### **ä»»åŠ¡ 1.3ï¼šæµ‹è¯•è¿æ¥**
```python
# test_ibkr_connection.py
from ib_insync import IB

ib = IB()
ib.connect('127.0.0.1', 7497, clientId=1)

# æ‰“å°è´¦æˆ·ä¿¡æ¯
print(ib.accountValues())

# è·å– AAPL æŠ¥ä»·
from ib_insync import Stock
aapl = Stock('AAPL', 'SMART', 'USD')
ib.qualifyContracts(aapl)
ticker = ib.reqMktData(aapl)
ib.sleep(1)
print(f"AAPL ä»·æ ¼ï¼š${ticker.marketPrice()}")

ib.disconnect()
```

---

### **Week 3-4ï¼šæ•°æ®å‡†å¤‡**

#### **ä»»åŠ¡ 2.1ï¼šå¯¼å‡ºå†å²æ•°æ®**
```bash
# ä» SQLite å¯¼å‡ºè®­ç»ƒæ•°æ®
python scripts/export_for_ml.py --lookback-days 180

# è¾“å‡ºï¼š
# ml_data/train_20250110.parquet (çº¦ 1.5GB)
# ml_data/val_20250110.parquet (çº¦ 300MB)
# ml_data/test_20250110.parquet (çº¦ 300MB)
```

#### **ä»»åŠ¡ 2.2ï¼šç‰¹å¾å·¥ç¨‹**
åˆ›å»ºæ–‡ä»¶ `ml/features.py`ï¼š
```python
def extract_features(analysis_result):
    """
    ä» analyzer.py çš„ç»“æœæå–ç‰¹å¾
    
    è¿”å›:
        features: numpy array [20 ç»´]
    """
    features = []
    
    # Greeksï¼ˆ4ä¸ªï¼‰
    greeks = analysis_result['greeks']
    features.extend([
        greeks['delta'],
        greeks['gamma'],
        greeks['vega'],
        greeks['theta']
    ])
    
    # æ³¢åŠ¨ç‡ç‰¹å¾ï¼ˆ4ä¸ªï¼‰
    garch = analysis_result['garch_volatility']
    features.extend([
        garch['predicted_volatility'],
        garch['current_iv'],
        garch['vol_mispricing'],
        garch['iv_percentile']
    ])
    
    # å‚…ç«‹å¶ç‰¹å¾ï¼ˆ3ä¸ªï¼‰
    fourier = analysis_result['fourier_analysis']
    features.extend([
        1 if fourier['trend_direction'] == 'UPTREND' else -1 if fourier['trend_direction'] == 'DOWNTREND' else 0,
        fourier['trend_slope'],
        fourier['dominant_period']
    ])
    
    # ARIMA ç‰¹å¾ï¼ˆ3ä¸ªï¼‰
    arima = analysis_result['arima_forecast']
    features.extend([
        arima['mean_forecast'],
        arima['price_stability'],
        (arima['upper_bound'] - arima['lower_bound']) / arima['mean_forecast']
    ])
    
    # ç­–ç•¥æŒ‡æ ‡ï¼ˆ3ä¸ªï¼‰
    strategy = analysis_result['butterfly_strategy']
    features.extend([
        strategy['profit_loss_ratio'],
        strategy['probability_of_profit'],
        strategy['net_cost']
    ])
    
    # å¸‚åœºç¯å¢ƒï¼ˆ3ä¸ªï¼‰
    features.extend([
        get_vix(),  # VIX æŒ‡æ•°
        get_spy_return(),  # SPY 5æ—¥æ”¶ç›Šç‡
        get_market_breadth()  # å¸‚åœºå®½åº¦
    ])
    
    return np.array(features, dtype=np.float32)
```

---

### **Week 5-8ï¼šæ¨¡å‹è®­ç»ƒï¼ˆåœ¨ä½ çš„ RTX 4060 ä¸Šï¼‰**

#### **æ–¹æ¡ˆé€‰æ‹©**
æ ¹æ®ä½ çš„éœ€æ±‚ï¼Œæˆ‘æ¨è **æ–¹æ¡ˆ 1ï¼ˆæƒé‡ä¼˜åŒ– + DQNï¼‰**ï¼ŒåŸå› ï¼š
1. ç®€å•ç›´æ¥ï¼Œæ˜“äºç†è§£å’Œè°ƒè¯•
2. è®­ç»ƒé€Ÿåº¦å¿«ï¼ˆæ¯è½® < 5 åˆ†é’Ÿï¼‰
3. å¯è§£é‡Šæ€§å¼ºï¼ˆç›´æ¥çœ‹æƒé‡å˜åŒ–ï¼‰

#### **è®­ç»ƒè„šæœ¬**
```bash
# åœ¨æœ¬åœ°è¿è¡Œï¼ˆRTX 4060ï¼‰
python ml/train_dqn.py \
  --data ml_data/train_20250110.parquet \
  --epochs 100 \
  --batch-size 64 \
  --lr 1e-4 \
  --save-dir models/

# é¢„è®¡è®­ç»ƒæ—¶é—´ï¼š2-4 å°æ—¶
```

#### **è®­ç»ƒç›‘æ§**
ä½¿ç”¨ TensorBoard å®æ—¶æŸ¥çœ‹ï¼š
```bash
tensorboard --logdir runs/
# æ‰“å¼€ http://localhost:6006
```

ç›‘æ§æŒ‡æ ‡ï¼š
- **Episode Reward**ï¼šæ¯è½®çš„ç´¯è®¡å¥–åŠ±ï¼ˆåº”è¯¥ä¸Šå‡ï¼‰
- **Learned Weights**ï¼š[w1, w2, w3, w4] çš„å˜åŒ–è¶‹åŠ¿
- **Baseline Comparison**ï¼šRL vs Baseline çš„ P&L å·®å¼‚

---

### **Week 9-10ï¼šæ¨¡å‹éƒ¨ç½²**

#### **ä»»åŠ¡ 4.1ï¼šå¯¼å‡ºæ¨¡å‹**
```bash
# è½¬æ¢ä¸º ONNXï¼ˆæ–¹ä¾¿éƒ¨ç½²ï¼‰
python ml/export_onnx.py \
  --checkpoint models/rl_agent_ep100.pth \
  --output models/rl_agent.onnx
```

#### **ä»»åŠ¡ 4.2ï¼šé›†æˆåˆ°äº¤æ˜“ç³»ç»Ÿ**
ä¿®æ”¹ `analyzer.py`ï¼š
```python
# analyzer.py
import onnxruntime as ort

class ButterflyAnalyzer:
    def __init__(self, ticker, use_rl=False):
        self.ticker = ticker
        self.use_rl = use_rl
        
        if use_rl:
            # åŠ è½½ RL æ¨¡å‹
            self.rl_session = ort.InferenceSession('models/rl_agent.onnx')
    
    def full_analysis(self, weights=None):
        # ... åŸæœ‰é€»è¾‘ ...
        
        if self.use_rl and weights is None:
            # ä» RL æ¨¡å‹é¢„æµ‹æƒé‡
            state = self._get_market_state()
            weights_array = self.rl_session.run(None, {'state': state})[0]
            weights = weights_array.tolist()
        elif weights is None:
            # ä½¿ç”¨å›ºå®šæƒé‡
            weights = [35, 30, 20, 15]
        
        # è®¡ç®—åˆ†æ•°
        score = self.calculate_strategy_score(
            fourier, arima, garch, butterfly, price_stability,
            weights=weights
        )
        
        # ... è¿”å›ç»“æœ
```

---

### **Week 11-12ï¼šPaper Trading æµ‹è¯•**

#### **ä»»åŠ¡ 5.1ï¼šå¯åŠ¨åŒè´¦æˆ·äº¤æ˜“**
```bash
# å¯åŠ¨äº¤æ˜“å®ˆæŠ¤è¿›ç¨‹
python trading/auto_trader.py \
  --baseline-account DU123456 \
  --rl-account DU789012 \
  --interval 1h  # æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡æœºä¼š
```

#### **ä»»åŠ¡ 5.2ï¼šç›‘æ§ç³»ç»Ÿ**
åˆ›å»º `trading/monitor.py`ï¼š
```python
import time
from trading.ibkr_trader import IBKRTrader

def monitor_accounts():
    """å®æ—¶ç›‘æ§åŒè´¦æˆ·"""
    baseline = IBKRTrader('baseline')
    rl = IBKRTrader('rl')
    
    while True:
        # è·å–ç›ˆäº
        baseline_pnl = baseline.get_pnl()
        rl_pnl = rl.get_pnl()
        
        # æ‰“å°å¯¹æ¯”
        print(f"\n{'='*50}")
        print(f"æ—¶é—´ï¼š{datetime.now()}")
        print(f"Baseline P&Lï¼š${baseline_pnl['unrealized_pnl']:.2f}")
        print(f"RL P&Lï¼š      ${rl_pnl['unrealized_pnl']:.2f}")
        print(f"å·®å¼‚ï¼š        ${rl_pnl['unrealized_pnl'] - baseline_pnl['unrealized_pnl']:.2f}")
        
        # è®¡ç®— Sharpe Ratio
        baseline_sharpe = calculate_sharpe(baseline)
        rl_sharpe = calculate_sharpe(rl)
        print(f"\nBaseline Sharpeï¼š{baseline_sharpe:.3f}")
        print(f"RL Sharpeï¼š      {rl_sharpe:.3f}")
        
        time.sleep(3600)  # æ¯å°æ—¶æ›´æ–°
```

---

### **Month 3-6ï¼šæŒç»­ä¼˜åŒ–**

#### **ä¼˜åŒ–æ–¹å‘ 1ï¼šå¥–åŠ±å‡½æ•°è°ƒæ•´**
å¦‚æœ RL è¡¨ç°ä¸ä½³ï¼Œå°è¯•ï¼š
```python
def _calculate_reward(self):
    """æ”¹è¿›çš„å¥–åŠ±å‡½æ•°"""
    # åŸå§‹ï¼šåªçœ‹ P&L
    # reward = daily_pnl / 1000.0
    
    # æ”¹è¿›ï¼šå¤šç›®æ ‡ä¼˜åŒ–
    reward = (
        daily_pnl / 1000.0 +           # æ”¶ç›Š
        sharpe * 0.2 +                  # Sharpe Ratio
        -max_drawdown * 0.5 +           # æƒ©ç½šå›æ’¤
        win_rate * 0.3 +                # èƒœç‡
        -num_trades * 0.01              # æƒ©ç½šè¿‡åº¦äº¤æ˜“
    )
    
    return reward
```

#### **ä¼˜åŒ–æ–¹å‘ 2ï¼šå¢åŠ çŠ¶æ€ç‰¹å¾**
```python
def _get_state(self):
    state = np.array([
        # åŸæœ‰ç‰¹å¾ ...
        
        # æ–°å¢ï¼šå¸‚åœºæƒ…ç»ªæŒ‡æ ‡
        get_put_call_ratio(),      # Put/Call Ratio
        get_vix_term_structure(),  # VIX æœŸé™ç»“æ„
        get_sector_rotation(),     # æ¿å—è½®åŠ¨
        
        # æ–°å¢ï¼šè´¦æˆ·çŠ¶æ€
        self.portfolio_value / 100000.0,
        len(self.positions) / 10.0,
        self.avg_holding_period / 30.0
    ])
    
    return state
```

#### **ä¼˜åŒ–æ–¹å‘ 3ï¼šæ¨¡å‹é›†æˆ**
```python
# åŒæ—¶è®­ç»ƒ 3 ä¸ªæ¨¡å‹ï¼ŒæŠ•ç¥¨å†³ç­–
models = [
    DQNAgent(),        # æ·±åº¦ Q ç½‘ç»œ
    PPOAgent(),        # è¿‘ç«¯ç­–ç•¥ä¼˜åŒ–
    BayesianAgent()    # è´å¶æ–¯ä¼˜åŒ–å™¨
]

# é›†æˆé¢„æµ‹
weights_list = [m.predict(state) for m in models]
final_weights = np.mean(weights_list, axis=0)  # å¹³å‡
```

---

## ğŸ“Š è¯„ä¼°æŒ‡æ ‡

### **ä¸»è¦æŒ‡æ ‡**
| æŒ‡æ ‡ | è®¡ç®—æ–¹å¼ | ç›®æ ‡ |
|------|---------|------|
| **ç´¯è®¡æ”¶ç›Š** | (å½“å‰å‡€å€¼ - åˆå§‹å‡€å€¼) / åˆå§‹å‡€å€¼ | RL > Baseline |
| **Sharpe Ratio** | (å¹´åŒ–æ”¶ç›Š - æ— é£é™©åˆ©ç‡) / å¹´åŒ–æ³¢åŠ¨ç‡ | RL > Baseline + 0.2 |
| **æœ€å¤§å›æ’¤** | max((å³°å€¼ - å½“å‰) / å³°å€¼) | RL < Baseline |
| **èƒœç‡** | ç›ˆåˆ©äº¤æ˜“æ•° / æ€»äº¤æ˜“æ•° | > 55% |
| **å¹³å‡æŒä»“æ—¶é—´** | æ‰€æœ‰äº¤æ˜“çš„æŒä»“å¤©æ•°å‡å€¼ | 7-14 å¤© |

### **æ¬¡è¦æŒ‡æ ‡**
- **äº¤æ˜“é¢‘ç‡**ï¼šæ¯å‘¨äº¤æ˜“æ¬¡æ•°ï¼ˆé¿å…è¿‡åº¦äº¤æ˜“ï¼‰
- **Greeks å¹³è¡¡**ï¼šDelta æ˜¯å¦æ¥è¿‘ 0ï¼ˆæ–¹å‘ä¸­æ€§ï¼‰
- **IV é”™è¯¯å®šä»·æ•æ‰ç‡**ï¼šé«˜ IV æ—¶å…¥åœºçš„æ¯”ä¾‹

---

## ğŸ¯ æˆåŠŸæ ‡å‡†

### **é˜¶æ®µ 1ï¼ˆ1-3ä¸ªæœˆï¼‰**
- âœ… RL è´¦æˆ·ä¸äºé’±ï¼ˆP&L > -5%ï¼‰
- âœ… å­¦åˆ°çš„æƒé‡ç¨³å®šï¼ˆæ ‡å‡†å·® < 5%ï¼‰
- âœ… æ— ä¸¥é‡ bugï¼ˆè®¢å•æ‰§è¡ŒæˆåŠŸç‡ > 95%ï¼‰

### **é˜¶æ®µ 2ï¼ˆ3-6ä¸ªæœˆï¼‰**
- âœ… RL è´¦æˆ· Sharpe > Baseline
- âœ… ç´¯è®¡æ”¶ç›Š > Baseline + 2%
- âœ… æ¨¡å‹å¯è§£é‡Šï¼ˆèƒ½è¯´æ¸…ä¸ºä»€ä¹ˆè°ƒæ•´æƒé‡ï¼‰

### **é˜¶æ®µ 3ï¼ˆ6-12ä¸ªæœˆï¼‰**
- âœ… è€ƒè™‘çœŸå®è´¦æˆ·ï¼ˆå°èµ„é‡‘ï¼‰
- âœ… æ‰©å±•åˆ°æ›´å¤šç­–ç•¥ï¼ˆIron Condorã€Straddleï¼‰
- âœ… å‘è¡¨ç ”ç©¶è®ºæ–‡/åšå®¢

---

## ğŸ’° æˆæœ¬ä¼°ç®—

| é¡¹ç›® | æˆæœ¬ |
|------|------|
| ç›ˆé€ Paper Trading | **Â¥0** |
| äº‘æœåŠ¡å™¨ï¼ˆå¯é€‰ï¼‰ | Â¥500/æœˆ |
| ç”µè´¹ï¼ˆRTX 4060 è®­ç»ƒï¼‰ | ~Â¥50/æœˆ |
| **æ€»è®¡** | **Â¥0-550/æœˆ** |

---

## âš ï¸ é£é™©æç¤º

### **æŠ€æœ¯é£é™©**
- RL æ¨¡å‹å¯èƒ½**è¿‡æ‹Ÿåˆ**ï¼ˆåœ¨å†å²æ•°æ®è¡¨ç°å¥½ï¼Œå®ç›˜å·®ï¼‰
- ç›ˆé€ API å¯èƒ½**æ‰çº¿**ï¼ˆéœ€è¦é‡è¿æœºåˆ¶ï¼‰
- æ¨¡å‹å¯èƒ½å­¦åˆ°**é”™è¯¯æ¨¡å¼**ï¼ˆä¾‹å¦‚åªåœ¨ç‰›å¸‚æœ‰æ•ˆï¼‰

### **åº”å¯¹æªæ–½**
1. **ä¸¥æ ¼çš„äº¤å‰éªŒè¯**ï¼ˆæŒ‰æ—¶é—´åˆ’åˆ†ï¼Œé¿å…æœªæ¥ä¿¡æ¯æ³„éœ²ï¼‰
2. **è‡ªåŠ¨é‡è¿æœºåˆ¶**ï¼ˆ`ib_insync` å†…ç½®ï¼‰
3. **å®šæœŸå›æµ‹**ï¼ˆæ¯æœˆç”¨æœ€æ–°æ•°æ®éªŒè¯ï¼‰

### **ä½•æ—¶åœæ­¢ RL äº¤æ˜“ï¼Ÿ**
**ç«‹å³åœæ­¢æ¡ä»¶**ï¼ˆæ»¡è¶³ä»»ä¸€ï¼‰ï¼š
- å•æ—¥äºæŸ > 3%
- ç´¯è®¡å›æ’¤ > 10%
- Sharpe Ratio è¿ç»­ 30 å¤© < 0
- æ¨¡å‹é¢„æµ‹çš„æƒé‡å‡ºç° NaN æˆ–è¶…å‡º [0, 100] èŒƒå›´

---

## ğŸ“ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### **æœ¬å‘¨**
- [ ] å¼€è®¾ç›ˆé€ Paper Trading è´¦æˆ·ï¼ˆ2ä¸ªï¼‰
- [ ] å®‰è£… `ib_insync` å¹¶æµ‹è¯•è¿æ¥
- [ ] å¯¼å‡ºå†å²æ•°æ®åˆ° Parquet

### **ä¸‹å‘¨**
- [ ] ç¼–å†™ç‰¹å¾å·¥ç¨‹è„šæœ¬ `ml/features.py`
- [ ] è®­ç»ƒç¬¬ä¸€ä¸ª DQN æ¨¡å‹
- [ ] åœ¨ Paper Trading æ‰§è¡Œç¬¬ä¸€ç¬”äº¤æ˜“

### **ä¸‹ä¸ªæœˆ**
- [ ] å¯åŠ¨åŒè´¦æˆ·è‡ªåŠ¨äº¤æ˜“
- [ ] æ¯æ—¥ç›‘æ§ RL vs Baseline
- [ ] æ”¶é›†åé¦ˆï¼Œè°ƒæ•´å¥–åŠ±å‡½æ•°

---

éœ€è¦æˆ‘è¯¦ç»†è®²è§£å“ªä¸ªéƒ¨åˆ†ï¼ŸğŸš€