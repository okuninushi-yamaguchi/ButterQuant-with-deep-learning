# backend/app.py - 优化版

import os
import json
import time
from flask import Flask, request, jsonify
from flask_cors import CORS
import redis
from functools import wraps
import logging

# ==================== 配置 ====================
REDIS_HOST = os.getenv('REDIS_HOST', 'localhost')
REDIS_PORT = int(os.getenv('REDIS_PORT', 6379))
CACHE_TTL = int(os.getenv('CACHE_TTL', 300))  # 5分钟

# ==================== 初始化 ====================
app = Flask(__name__)
CORS(app)

# 配置日志
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Redis 连接池（复用连接）
redis_pool = redis.ConnectionPool(
    host=REDIS_HOST,
    port=REDIS_PORT,
    db=0,
    max_connections=50,
    decode_responses=True
)
redis_client = redis.Redis(connection_pool=redis_pool)

# ==================== 缓存装饰器 ====================
def cache_result(cache_key_func, ttl=CACHE_TTL):
    """通用缓存装饰器"""
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            # 生成缓存键
            cache_key = cache_key_func(*args, **kwargs)
            
            # 尝试从缓存获取
            try:
                cached = redis_client.get(cache_key)
                if cached:
                    logger.info(f"Cache HIT: {cache_key}")
                    return json.loads(cached), True  # 返回数据 + 缓存标记
            except redis.RedisError as e:
                logger.error(f"Redis error: {e}")
            
            # 缓存未命中，执行函数
            logger.info(f"Cache MISS: {cache_key}")
            result = func(*args, **kwargs)
            
            # 存入缓存
            try:
                redis_client.setex(
                    cache_key,
                    ttl,
                    json.dumps(result, ensure_ascii=False)
                )
            except redis.RedisError as e:
                logger.error(f"Failed to set cache: {e}")
            
            return result, False
        
        return wrapper
    return decorator

# ==================== 业务逻辑 ====================
def perform_analysis(ticker):
    """执行完整分析（你的原有逻辑）"""
    from analyzer import ButterflyAnalyzer
    
    start_time = time.time()
    analyzer = ButterflyAnalyzer(ticker)
    result = analyzer.full_analysis()
    
    elapsed = time.time() - start_time
    logger.info(f"Analysis for {ticker} completed in {elapsed:.2f}s")
    
    return result

# ==================== API 路由 ====================
@app.route('/api/health', methods=['GET'])
def health_check():
    """健康检查接口"""
    try:
        redis_client.ping()
        redis_status = 'healthy'
    except:
        redis_status = 'unhealthy'
    
    return jsonify({
        'status': 'ok',
        'redis': redis_status,
        'timestamp': time.time()
    })

@app.route('/api/analyze', methods=['POST'])
@cache_result(
    cache_key_func=lambda: f"analysis:{request.json.get('ticker', 'AAPL').upper()}",
    ttl=CACHE_TTL
)
def analyze():
    """主分析接口（带缓存）"""
    try:
        ticker = request.json.get('ticker', 'AAPL').upper()
        result = perform_analysis(ticker)
        return result
    except Exception as e:
        logger.error(f"Analysis error: {e}", exc_info=True)
        raise

@app.after_request
def after_request(response):
    """添加响应头（标记是否来自缓存）"""
    if response.status_code == 200:
        try:
            data = response.get_json()
            # 检查是否是缓存数据（通过装饰器的返回值判断）
            if isinstance(data, tuple) and len(data) == 2:
                result, from_cache = data
                response.set_data(json.dumps({
                    'success': True,
                    'data': result,
                    'from_cache': from_cache
                }))
        except:
            pass
    return response

@app.route('/api/cache/stats', methods=['GET'])
def cache_stats():
    """缓存统计"""
    try:
        info = redis_client.info('stats')
        memory = redis_client.info('memory')
        
        return jsonify({
            'total_connections': info.get('total_connections_received', 0),
            'keyspace_hits': info.get('keyspace_hits', 0),
            'keyspace_misses': info.get('keyspace_misses', 0),
            'hit_rate': round(
                info.get('keyspace_hits', 0) / 
                max(info.get('keyspace_hits', 0) + info.get('keyspace_misses', 0), 1) * 100,
                2
            ),
            'used_memory_human': memory.get('used_memory_human'),
            'total_keys': redis_client.dbsize()
        })
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/api/cache/clear', methods=['POST'])
def clear_cache():
    """清空缓存"""
    try:
        redis_client.flushdb()
        return jsonify({'success': True, 'message': 'Cache cleared'})
    except Exception as e:
        return jsonify({'error': str(e)}), 500

# ==================== 数据库优化 ====================
from database import DatabaseManager

# 初始化时创建索引
db = DatabaseManager()
db.create_indexes()  # 需要在 database.py 中添加这个方法

# ==================== 启动应用 ====================
if __name__ == '__main__':
    # 开发环境直接运行
    app.run(debug=True, host='0.0.0.0', port=5000)