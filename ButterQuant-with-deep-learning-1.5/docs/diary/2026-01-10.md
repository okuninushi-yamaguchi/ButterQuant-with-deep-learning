# ButterQuant 开发日志 (Diary) - 2026-01-10

## 📝 今日工作总结
今天迈出了 ButterQuant 深度学习集成的关键一步。作为 IT 新手，我们成功完成了一个完整的从“数据存储”到“特征准备”的闭环。

### 1. 核心架构规划 (Planning)
- [x] 制定了《深度学习集成实施计划》。
- [x] 确立了“双账户”对比策略：使用同一个 IBKR 模拟账户，通过软件层面的 `orderRef` (订单参考号) 区分基准组和实验组。

### 2. 数据库架构升级 (Infrastructure)
- [x] **引入 TimescaleDB**：配置了 Docker Compose 环境，将原本的 SQLite 升级为高性能的 PostgreSQL/TimescaleDB 时序数据库。
- [x] **数据搬家 (Migration)**：编写并运行了迁移脚本，将 **2705 条** 历史分析记录成功搬入新库，并解决了 JSON 数据中的 `NaN` 处理难题。

### 3. 特征工程流水线 (Feature Engineering)
- [x] **自动化特征提取**：创建了 `ml/features.py`，能够自动从复杂的分析 JSON 中解构出希腊字母、周期、斜率等关键指标。
- [x] **自动打标签 (Labeling)**：集成了 `yfinance` 历史价格接口，系统现在能自动判断每一个历史预测是否获利（“成功”或“失败”）。
- [x] **数据集生成**：成功导出了第一份包含 **1037 条** 样本的训练集 (`ml/training_data.parquet`)。

### 4. 模型开发 (Model Development) - Phase 2 完成
- [x] **环境就绪**：确认了 PyTorch, Scikit-learn 等 AI 框架已正确配置，并能调用您的 **RTX 4060 GPU** 进行加速。
- [x] **首个模型诞生**：编写了 `ml/train_model.py`，成功训练了一个基于多层感知器 (MLP) 的分类模型，用于预测蝴蝶策略的成功率。
- [x] **模型持久化**：训练好的模型权重 (`success_model.pth`) 和特征缩放器 (`scaler.joblib`) 已保存至 `ml/models/`，准备好进行推理。

### 5. 系统集成 (System Integration) - Phase 3 完成
- [x] **推理引擎开发**：创建了 `backend/ml_inference.py`，封装了 PyTorch 模型加载和预测逻辑，支持单例模式以提高性能。
- [x] **ONNX 性能优化**：为了提高推理效率，将 PyTorch 模型成功导出为 **ONNX** 格式，并切换后端计算引擎为 `onnxruntime`。这不仅让推理速度达到毫秒级，还剥离了庞大的 PyTorch 依赖，让后端更轻量。
- [x] **核心逻辑植入**：成功修改了 `backend/analyzer.py`，在传统算法分析完成后，自动调用 AI 模型计算 `ml_success_prob` (成功概览)。
- [x] **闭环验证**：通过 `test_integration.py` 验证了从“数据获取”->“特征计算”->“AI 打分”的全链路流程。

## 💡 技术感悟 (Learnings)
- **JSONB 的严格性**：PostgreSQL 的 JSONB 格式不支持 `NaN`，在迁移时必须转换为 `null`。
- **数据对齐**：在回测/打标签时，必须考虑周末和非交易日，通过获取最近的交易日价格来确保标签的可信度。
- **环境隔离**：使用 Docker 极大地简化了数据库这种复杂中间件的安装。

## 📅 明日预告
## 📅 明日预告
- **Phase 4**: 将 AI 模型部署到 IBKR 模拟交易环境，开始实盘验证。
- **监控与优化**: 观察 AI 模型的预测准确率，并根据反馈进行模型微调。
- 观察数据集在 1 天/7 天不同周期下的表现差异。

---
*记录人：ButterQuant Assistant (Antigravity)*
